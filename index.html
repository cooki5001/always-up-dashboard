<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Always Up (Vibe) Dashboard</title>
  <meta name="description" content="Always-up vibe charts + sentiment + M2. Free data dashboard." />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    :root{
      --bg0:#eaffef; --bg1:#ffffff;
      --txt:#0b0b0b; --muted:rgba(0,0,0,.62); --muted2:rgba(0,0,0,.45);
      --card:rgba(255,255,255,.72); --border:rgba(0,0,0,.08);
      --shadow: 0 18px 60px -40px rgba(0,0,0,.35);
      --pill:rgba(255,255,255,.65);
      --accent:#0b0b0b; --accentTxt:#ffffff;
      --goodBg: rgba(16,185,129,.10); --goodBd: rgba(16,185,129,.22); --goodTx: rgba(6,95,70,.95);
      --warnBg: rgba(245,158,11,.12); --warnBd: rgba(245,158,11,.25); --warnTx: rgba(146,64,14,.95);
      --badBg: rgba(239,68,68,.10);  --badBd: rgba(239,68,68,.22);  --badTx: rgba(127,29,29,.95);
    }
    [data-theme="dark"]{
      --bg0:#0b1220; --bg1:#070b14;
      --txt:#ffffff; --muted:rgba(255,255,255,.68); --muted2:rgba(255,255,255,.46);
      --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --shadow: 0 18px 60px -40px rgba(0,0,0,.85);
      --pill:rgba(255,255,255,.08);
      --accent:#ffffff; --accentTxt:#0b0b0b;
      --goodBg: rgba(16,185,129,.10); --goodBd: rgba(16,185,129,.22); --goodTx: rgba(167,243,208,.92);
      --warnBg: rgba(245,158,11,.12); --warnBd: rgba(245,158,11,.25); --warnTx: rgba(253,230,138,.90);
      --badBg: rgba(239,68,68,.10);  --badBd: rgba(239,68,68,.22);  --badTx: rgba(254,202,202,.92);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(to bottom, var(--bg0), var(--bg1) 45%, var(--bg1));
      color:var(--txt);
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{ max-width:1120px; margin:0 auto; padding:26px 18px 42px; }
    .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap; }

    .brand{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .logo{
      width:40px; height:40px; border-radius:16px;
      border:1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      backdrop-filter: blur(12px);
    }
    .ico{ width:16px; height:16px; display:inline-block; vertical-align:middle; }

    h1{ margin:0; font-size:26px; letter-spacing:-0.02em; }
    .sub{ margin-top:8px; color:var(--muted); font-size:13px; max-width:820px; }

    .btn{
      border-radius:16px;
      border:1px solid var(--border);
      background: var(--card);
      padding:10px 12px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      backdrop-filter: blur(12px);
      transition: transform .12s ease, opacity .12s ease, background .12s ease;
      box-shadow: 0 10px 34px -26px rgba(0,0,0,.45);
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(.99); opacity:.95; }
    .btn.primary{ background: var(--accent); border-color: var(--accent); color: var(--accentTxt); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }

    .chip{
      display:inline-flex; align-items:center; gap:7px;
      border-radius:999px;
      padding:7px 11px;
      background: var(--pill);
      border:1px solid var(--border);
      color: var(--muted);
      font-size:12px;
      backdrop-filter: blur(12px);
      white-space:nowrap;
    }
    .chip.good{ background: var(--goodBg); border-color: var(--goodBd); color: var(--goodTx); }
    .chip.warn{ background: var(--warnBg); border-color: var(--warnBd); color: var(--warnTx); }
    .chip.bad { background: var(--badBg);  border-color: var(--badBd);  color: var(--badTx); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:16px; }

    .seg{
      display:inline-flex; padding:4px; border-radius:999px;
      border:1px solid var(--border); background: var(--pill);
      backdrop-filter: blur(12px);
    }
    .seg button{
      border:0; background:transparent; cursor:pointer;
      padding:10px 14px; border-radius:999px;
      color: var(--muted); font-size:14px;
      transition: background .12s ease, color .12s ease;
    }
    .seg button.active{ background: var(--accent); color: var(--accentTxt); }

    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .gridWide{ display:grid; grid-template-columns: 2fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 980px){ .gridWide{ grid-template-columns:1fr; } }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns:1fr; } }

    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 980px){ .grid3{ grid-template-columns:1fr; } }

    .card{
      border-radius:22px; border:1px solid var(--border);
      background: var(--card); padding:16px;
      backdrop-filter: blur(14px); box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .card:before{
      content:""; position:absolute; inset:-1px;
      background: radial-gradient(1200px 220px at 20% 0%, rgba(16,185,129,.12), transparent 55%);
      pointer-events:none; opacity:.55;
    }
    [data-theme="dark"] .card:before{ opacity:.22; }

    .k{ color:var(--muted); font-size:12px; position:relative; }
    .v{ font-size:24px; font-weight:760; margin-top:7px; letter-spacing:-0.02em; position:relative; }
    .mini{ color:var(--muted2); font-size:12px; margin-top:6px; position:relative; }
    .chart{ height: 340px; margin-top: 10px; position:relative; }
    .chart.sm{ height: 250px; }
    .chart.xs{ height: 210px; }

    details{
      margin-top: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 18px;
      padding: 10px 12px;
      backdrop-filter: blur(14px);
      box-shadow: 0 10px 34px -26px rgba(0,0,0,.45);
    }
    summary{ cursor:pointer; color:var(--muted); font-size:13px; }
    .diag{ margin-top:10px; display:grid; grid-template-columns: 1fr; gap:8px; }
    .diagItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background: var(--pill);
      font-size:12px;
      color: var(--muted);
    }
    .diagLeft{ display:flex; gap:8px; align-items:center; min-width: 0; }
    .dot{ width:9px; height:9px; border-radius:999px; background: rgba(0,0,0,.2); flex:0 0 auto; }
    [data-theme="dark"] .dot{ background: rgba(255,255,255,.25); }
    .dot.ok{ background: rgba(16,185,129,.9); }
    .dot.fail{ background: rgba(239,68,68,.9); }
    .diagMsg{
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 680px;
    }
    .spin{ animation: spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 17l6-6 4 4 8-8" />
            <path d="M14 7h7v7" />
          </svg>
        </div>
        <h1>Always Up (Vibe) Dashboard</h1>
        <span class="chip good" style="margin-left:4px;">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2l1.2 4.2L17 7.4l-3.8 1.2L12 13l-1.2-4.4L7 7.4l3.8-1.2L12 2z"/>
          </svg>
          vibes
        </span>
        <span id="updated" class="chip">Last update: -</span>
      </div>
      <div class="sub">
        ✅ 모든 차트는 <b>최근 1년</b>으로 고정 표시. <br/>
        ✅ 데이터가 안 뜰 때를 대비해 <b>다중 프록시 자동 fallback</b> + <b>진단 패널</b> 포함.
      </div>
    </div>

    <div class="row" style="margin-top:0;">
      <button id="toggleTheme" class="btn" title="Dark/Light">
        <span id="themeIcon" aria-hidden="true"></span>
        <span id="themeLabel" style="font-size:13px;"></span>
      </button>

      <button id="refresh" class="btn primary">
        <span id="refreshIcon" aria-hidden="true">
          <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-3-6.7"/>
            <path d="M21 3v7h-7"/>
          </svg>
        </span>
        Refresh
      </button>
    </div>
  </div>

  <div class="row">
    <div class="seg" role="tablist" aria-label="Asset tabs">
      <button id="tabStocks" class="active" role="tab" aria-selected="true">Stocks</button>
      <button id="tabCrypto" role="tab" aria-selected="false">Crypto</button>
    </div>

    <span id="fgStocks" class="chip">Stocks F&G: (loading)</span>
    <span id="fgCrypto" class="chip">Crypto F&G: (loading)</span>
    <span class="chip" title="Vibe definition">log return → abs() → accumulate</span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="k">SPY 1Y Return</div>
      <div id="spyRet" class="v">loading…</div>
      <div class="mini">(최근 1년, 일봉)</div>
    </div>
    <div class="card">
      <div class="k">QQQ 1Y Return</div>
      <div id="qqqRet" class="v">loading…</div>
      <div class="mini">(최근 1년, 일봉)</div>
    </div>
    <div class="card">
      <div class="k">Mode</div>
      <div id="mode" class="v">Stocks</div>
      <div class="mini">모든 차트는 최근 1년 범위</div>
    </div>
  </div>

  <div class="gridWide">
    <div class="card">
      <div class="k">Vibe Chart (항상 우상향)</div>
      <div id="titleVibe" class="v" style="font-size:18px; margin-top:8px;">SPY (vibe-adjusted)</div>
      <div id="chartVibe" class="chart"></div>
      <div class="mini">Normalized to 100</div>
    </div>

    <div class="card">
      <div class="k">Raw vs Vibe</div>
      <div id="titleRaw" class="v" style="font-size:18px; margin-top:8px;">SPY</div>
      <div id="chartRaw" class="chart"></div>
      <div class="mini">실제 가격 vs vibe 가격</div>
    </div>
  </div>

  <!-- NEW: Fear & Greed history charts -->
  <div class="grid2">
    <div class="card">
      <div class="k">Fear & Greed History (Stocks - proxy from VIX)</div>
      <div class="v" style="font-size:18px; margin-top:8px;">Stocks F&G (last 1Y)</div>
      <div id="chartFGStocks" class="chart xs"></div>
      <div class="mini">무료 소스 기반: VIX→F&G 간이 스케일</div>
    </div>
    <div class="card">
      <div class="k">Fear & Greed History (Crypto)</div>
      <div class="v" style="font-size:18px; margin-top:8px;">Crypto F&G (last 1Y)</div>
      <div id="chartFGCrypto" class="chart xs"></div>
      <div class="mini">Alternative.me (limit=365) + 프록시 fallback</div>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="k">M2 Money Supply (US)</div>
      <div class="v" style="font-size:18px; margin-top:8px;">FRED M2SL (last 1Y)</div>
      <div id="chartM2US" class="chart sm"></div>
    </div>
    <div class="card">
      <div class="k">M2 Money Supply (Korea)</div>
      <div class="v" style="font-size:18px; margin-top:8px;">FRED Korea M2 (last 1Y)</div>
      <div id="chartM2KR" class="chart sm"></div>
    </div>
  </div>

  <!-- Diagnostics -->
  <details>
    <summary>진단 패널 (데이터가 안 뜰 때 어디가 실패했는지 확인)</summary>
    <div class="diag" id="diag"></div>
  </details>
</div>

<script>
  // ----------------- Date helpers (force last 1Y) -----------------
  function toDate(s){ return new Date(s + "T00:00:00Z"); }
  function iso(d){ return d.toISOString().slice(0,10); }
  function lastNDaysFilter(points, days){
    const end = new Date();
    const start = new Date(end);
    start.setDate(end.getDate() - days);
    return points.filter(p => toDate(p.t) >= start && toDate(p.t) <= end);
  }

  // ----------------- Robust fetch with proxy fallback -----------------
  // Many free proxies are flaky; we try multiple. If one fails, try next.
  const PROXIES = [
    (url) => url, // direct first (works for some APIs)
    (url) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url),
    (url) => "https://r.jina.ai/https://" + url.replace(/^https?:\/\//,''),
    (url) => "https://r.jina.ai/http://" + url.replace(/^https?:\/\//,''),
    (url) => "https://corsproxy.io/?" + encodeURIComponent(url),
  ];

  async function fetchWithFallback(url, { timeoutMs = 12000, as = "text", validateText } = {}) {
    let lastErr = null;
    for (const proxify of PROXIES) {
      const finalUrl = proxify(url);
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(finalUrl, { signal: controller.signal, cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = (as === "json") ? await res.json() : await res.text();
        if (as === "text" && validateText) {
          const ok = validateText(String(data));
          if (!ok) throw new Error("Validation failed (not expected format)");
        }
        return { data, via: finalUrl };
      } catch (e) {
        lastErr = `${finalUrl} → ${e.message || e}`;
      } finally {
        clearTimeout(t);
      }
    }
    throw new Error(lastErr || "All proxies failed");
  }

  // ----------------- CSV / math -----------------
  function parseCSV(text) {
    const clean = String(text).replace(/^\uFEFF/, "").trim();
    const lines = clean.split(/\r?\n/).filter(Boolean);
    const header = lines[0].split(",");
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      if (cols.length !== header.length) continue;
      const obj = {};
      header.forEach((h, idx) => obj[h.trim()] = (cols[idx] ?? "").trim());
      rows.push(obj);
    }
    return rows;
  }

  function pctChange(a, b) { return ((b - a) / a) * 100; }

  // Vibe transform
  function vibeSeries(points) {
    if (!points.length) return [];
    let acc = Math.log(points[0].p);
    const out = [{ t: points[0].t, vibe: points[0].p }];
    for (let i = 1; i < points.length; i++) {
      const prev = points[i - 1].p;
      const cur = points[i].p;
      const r = Math.log(cur / prev);
      acc += Math.abs(r);
      out.push({ t: points[i].t, vibe: Math.exp(acc) });
    }
    const base = out[0].vibe;
    return out.map((x) => ({ ...x, vibeNorm: (x.vibe / base) * 100 }));
  }

  function labelFG(v) {
    if (v <= 25) return "Extreme Fear";
    if (v <= 45) return "Fear";
    if (v <= 55) return "Neutral";
    if (v <= 75) return "Greed";
    return "Extreme Greed";
  }
  function fgToneClass(v) {
    if (v <= 35) return "bad";
    if (v <= 45) return "warn";
    if (v >= 65) return "good";
    return "";
  }

  // Stocks F&G proxy from VIX
  function vixToFG(vix) {
    const v = Math.max(10, Math.min(45, vix));
    const score = 100 - ((v - 10) / (45 - 10)) * 85;
    return Math.round(Math.max(0, Math.min(100, score)));
  }

  // ----------------- Data fetchers (validated) -----------------
  async function fetchStooqDaily(symbol) {
    const url = `https://stooq.com/q/d/l/?s=${symbol}&i=d`;
    const { data, via } = await fetchWithFallback(url, {
      as: "text",
      validateText: (t) => t.includes("Date,Open,High,Low,Close"),
    });
    const rows = parseCSV(data);
    const pts = rows
      .filter((r) => r.Date && r.Close && r.Close !== "null")
      .map((r) => ({ t: r.Date, p: Number(r.Close) }))
      .filter((x) => Number.isFinite(x.p));

    // Force last 365 days (calendar)
    return { pts: lastNDaysFilter(pts, 365), via };
  }

  async function fetchFREDcsv(seriesId) {
    const url = `https://fred.stlouisfed.org/graph/fredgraph.csv?id=${seriesId}`;
    const { data, via } = await fetchWithFallback(url, {
      as: "text",
      validateText: (t) => t.includes("DATE," + seriesId),
    });
    const rows = parseCSV(data);
    const pts = rows
      .filter((r) => r.DATE && r[seriesId] && r[seriesId] !== ".")
      .map((r) => ({ t: r.DATE, v: Number(r[seriesId]) }))
      .filter((x) => Number.isFinite(x.v));

    return { pts: lastNDaysFilter(pts, 365), via };
  }

  async function fetchCryptoFGHistory() {
    // Alternative.me supports limit; we request 365 points.
    const url = "https://api.alternative.me/fng/?limit=365&format=json&date_format=us";
    const { data, via } = await fetchWithFallback(url, { as: "json" });

    const arr = (data && data.data) ? data.data : [];
    // Each item: { value, value_classification, timestamp, time_until_update }
    const pts = arr
      .map(x => {
        const ts = Number(x.timestamp) * 1000;
        const d = new Date(ts);
        return { t: d.toISOString().slice(0,10), v: Number(x.value) };
      })
      .filter(x => Number.isFinite(x.v));

    // ensure ascending & last 1y
    pts.sort((a,b)=> toDate(a.t) - toDate(b.t));
    return { pts: lastNDaysFilter(pts, 365), via };
  }

  // ----------------- Charts -----------------
  const chartVibe   = echarts.init(document.getElementById("chartVibe"));
  const chartRaw    = echarts.init(document.getElementById("chartRaw"));
  const chartM2US   = echarts.init(document.getElementById("chartM2US"));
  const chartM2KR   = echarts.init(document.getElementById("chartM2KR"));
  const chartFGS    = echarts.init(document.getElementById("chartFGStocks"));
  const chartFGC    = echarts.init(document.getElementById("chartFGCrypto"));

  function axisTheme() {
    const isDark = document.documentElement.getAttribute("data-theme") === "dark";
    return {
      axisLine: { lineStyle: { color: isDark ? "rgba(255,255,255,.18)" : "rgba(0,0,0,.12)" } },
      axisTick: { show: false },
      axisLabel: { color: isDark ? "rgba(255,255,255,.55)" : "rgba(0,0,0,.45)", fontSize: 11 },
      splitLine: { lineStyle: { color: isDark ? "rgba(255,255,255,.06)" : "rgba(0,0,0,.06)" } },
    };
  }

  function mkOption({ title, x, series, area = false, yMin = null, yMax = null }) {
    const isDark = document.documentElement.getAttribute("data-theme") === "dark";
    const ax = axisTheme();
    const yAxis = { type:"value", ...ax, axisLabel:{...ax.axisLabel, show:false}, splitLine:{...ax.splitLine, show:false} };
    if (yMin !== null) yAxis.min = yMin;
    if (yMax !== null) yAxis.max = yMax;

    return {
      animationDuration: 450,
      title: { text: title, left: 0, top: 0, textStyle: { fontSize: 12, fontWeight: 650, color: isDark ? "#fff" : "#0b0b0b" } },
      tooltip: {
        trigger: "axis",
        backgroundColor: isDark ? "rgba(10,12,18,.92)" : "rgba(255,255,255,.92)",
        borderColor: isDark ? "rgba(255,255,255,.12)" : "rgba(0,0,0,.12)",
        textStyle: { color: isDark ? "rgba(255,255,255,.85)" : "rgba(0,0,0,.80)" },
        extraCssText: "backdrop-filter: blur(8px); border-radius: 12px;",
      },
      grid: { left: 12, right: 12, top: 28, bottom: 18, containLabel: true },
      xAxis: { type: "category", data: x, boundaryGap: false, ...ax, axisLabel: { ...ax.axisLabel, show: false } },
      yAxis,
      series: series.map((s) => ({
        ...s,
        type: "line",
        showSymbol: false,
        smooth: true,
        lineStyle: { width: 2 },
        areaStyle: area ? { opacity: 0.16 } : undefined,
      })),
      legend: { show: false },
    };
  }

  // ----------------- Diagnostics UI -----------------
  const diagEl = document.getElementById("diag");
  const diagState = {};
  function setDiag(key, ok, msg){
    diagState[key] = { ok, msg, t: new Date() };
    renderDiag();
  }
  function renderDiag(){
    diagEl.innerHTML = "";
    Object.entries(diagState).forEach(([k, v]) => {
      const row = document.createElement("div");
      row.className = "diagItem";
      row.innerHTML = `
        <div class="diagLeft">
          <span class="dot ${v.ok ? "ok" : "fail"}"></span>
          <span style="min-width:90px; color: var(--txt);">${k}</span>
          <span class="diagMsg">${v.msg}</span>
        </div>
        <div style="flex:0 0 auto; color: var(--muted2);">${v.t.toLocaleTimeString()}</div>
      `;
      diagEl.appendChild(row);
    });
  }

  // ----------------- App state -----------------
  let tab = "stocks";
  let SPY=[], QQQ=[], BTCUSD=[], VIX=[];
  let M2US=[], M2KR=[];
  let fgStocksNow = 50, fgCryptoNow = 50;
  let fgStocksHist = [], fgCryptoHist = [];

  function setTab(next) {
    tab = next;
    const stocksBtn = document.getElementById("tabStocks");
    const cryptoBtn = document.getElementById("tabCrypto");
    stocksBtn.classList.toggle("active", tab === "stocks");
    cryptoBtn.classList.toggle("active", tab === "crypto");
    stocksBtn.setAttribute("aria-selected", tab === "stocks");
    cryptoBtn.setAttribute("aria-selected", tab === "crypto");
    document.getElementById("mode").textContent = tab === "stocks" ? "Stocks" : "Crypto";
    render();
  }

  function compute1YReturn(series) {
    if (!series.length) return 0;
    return pctChange(series[0].p, series[series.length - 1].p);
  }

  function render(){
    // returns
    const spyRet = compute1YReturn(SPY);
    const qqqRet = compute1YReturn(QQQ);
    document.getElementById("spyRet").textContent = Number.isFinite(spyRet) ? spyRet.toFixed(2) + "%" : "-";
    document.getElementById("qqqRet").textContent = Number.isFinite(qqqRet) ? qqqRet.toFixed(2) + "%" : "-";

    // F&G chips
    const fgStocksEl = document.getElementById("fgStocks");
    fgStocksEl.className = "chip " + fgToneClass(fgStocksNow);
    fgStocksEl.textContent = `Stocks F&G: ${fgStocksNow} (${labelFG(fgStocksNow)})`;

    const fgCryptoEl = document.getElementById("fgCrypto");
    fgCryptoEl.className = "chip " + fgToneClass(fgCryptoNow);
    fgCryptoEl.textContent = `Crypto F&G: ${fgCryptoNow} (${labelFG(fgCryptoNow)})`;

    // active series
    const active = tab === "stocks" ? SPY : BTCUSD;
    const activeName = tab === "stocks" ? "SPY" : "BTCUSD";
    document.getElementById("titleVibe").textContent = `${activeName} (vibe-adjusted)`;
    document.getElementById("titleRaw").textContent = activeName;

    // charts: vibe + raw
    const vibe = vibeSeries(active);
    chartVibe.setOption(mkOption({
      title: "Vibe (Normalized=100, last 1Y)",
      x: vibe.map(d=>d.t),
      series: [{ name:"Vibe", data: vibe.map(d=>d.vibeNorm) }],
      area: true
    }), true);

    chartRaw.setOption(mkOption({
      title: "Raw vs Vibe (last 1Y)",
      x: active.map(d=>d.t),
      series: [
        { name:"Raw", data: active.map(d=>d.p) },
        { name:"Vibe", data: vibe.map(d=>d.vibe) }
      ],
      area: false
    }), true);

    // M2 last 1Y
    chartM2US.setOption(mkOption({
      title:"US M2 (last 1Y)",
      x: M2US.map(d=>d.t),
      series:[{ name:"M2US", data: M2US.map(d=>d.v) }],
      area:true
    }), true);

    chartM2KR.setOption(mkOption({
      title:"Korea M2 (last 1Y)",
      x: M2KR.map(d=>d.t),
      series:[{ name:"M2KR", data: M2KR.map(d=>d.v) }],
      area:true
    }), true);

    // F&G charts (0~100 fixed)
    chartFGS.setOption(mkOption({
      title:"Stocks F&G (last 1Y)",
      x: fgStocksHist.map(d=>d.t),
      series:[{ name:"F&G", data: fgStocksHist.map(d=>d.v) }],
      area:true,
      yMin: 0, yMax: 100
    }), true);

    chartFGC.setOption(mkOption({
      title:"Crypto F&G (last 1Y)",
      x: fgCryptoHist.map(d=>d.t),
      series:[{ name:"F&G", data: fgCryptoHist.map(d=>d.v) }],
      area:true,
      yMin: 0, yMax: 100
    }), true);

    chartVibe.resize(); chartRaw.resize(); chartM2US.resize(); chartM2KR.resize(); chartFGS.resize(); chartFGC.resize();
  }

  function setLoading(isLoading){
    const btn = document.getElementById("refresh");
    const icon = document.getElementById("refreshIcon");
    btn.disabled = isLoading;
    if (isLoading) icon.classList.add("spin");
    else icon.classList.remove("spin");
  }

  async function loadAll(){
    setLoading(true);
    setDiag("SPY", true, "Loading...");
    setDiag("QQQ", true, "Loading...");
    setDiag("VIX", true, "Loading...");
    setDiag("BTCUSD", true, "Loading...");
    setDiag("M2 US", true, "Loading...");
    setDiag("M2 KR", true, "Loading...");
    setDiag("Crypto F&G", true, "Loading...");

    try{
      const [spy, qqq, vix, btc, m2us, m2kr, fgC] = await Promise.all([
        fetchStooqDaily("spy.us").catch(e => ({ error: e })),
        fetchStooqDaily("qqq.us").catch(e => ({ error: e })),
        fetchStooqDaily("vix").catch(e => ({ error: e })),
        fetchStooqDaily("btcusd").catch(e => ({ error: e })),
        fetchFREDcsv("M2SL").catch(e => ({ error: e })),
        fetchFREDcsv("MYAGM2KRM189S").catch(e => ({ error: e })),
        fetchCryptoFGHistory().catch(e => ({ error: e })),
      ]);

      // SPY
      if (spy.error) { setDiag("SPY", false, spy.error.message); }
      else { SPY = spy.pts; setDiag("SPY", true, "OK via " + new URL(spy.via).host); }

      // QQQ
      if (qqq.error) { setDiag("QQQ", false, qqq.error.message); }
      else { QQQ = qqq.pts; setDiag("QQQ", true, "OK via " + new URL(qqq.via).host); }

      // VIX
      if (vix.error) { setDiag("VIX", false, vix.error.message); }
      else {
        VIX = vix.pts;
        setDiag("VIX", true, "OK via " + new URL(vix.via).host);
        // build stocks F&G history from VIX
        fgStocksHist = VIX.map(p => ({ t: p.t, v: vixToFG(p.p) }));
        fgStocksNow = fgStocksHist.length ? fgStocksHist[fgStocksHist.length-1].v : 50;
      }

      // BTCUSD
      if (btc.error) { setDiag("BTCUSD", false, btc.error.message); }
      else { BTCUSD = btc.pts; setDiag("BTCUSD", true, "OK via " + new URL(btc.via).host); }

      // M2
      if (m2us.error) { setDiag("M2 US", false, m2us.error.message); }
      else { M2US = m2us.pts; setDiag("M2 US", true, "OK via " + new URL(m2us.via).host); }

      if (m2kr.error) { setDiag("M2 KR", false, m2kr.error.message); }
      else { M2KR = m2kr.pts; setDiag("M2 KR", true, "OK via " + new URL(m2kr.via).host); }

      // Crypto F&G history + now
      if (fgC.error) { setDiag("Crypto F&G", false, fgC.error.message); }
      else {
        fgCryptoHist = fgC.pts;
        fgCryptoNow = fgCryptoHist.length ? fgCryptoHist[fgCryptoHist.length-1].v : 50;
        setDiag("Crypto F&G", true, "OK via " + new URL(fgC.via).host);
      }

      document.getElementById("updated").textContent = "Last update: " + new Date().toLocaleString();

      render();
    } catch (e){
      console.error(e);
      setDiag("Global", false, e.message || String(e));
      alert("데이터 로딩 실패: " + (e?.message || e));
    } finally {
      setLoading(false);
    }
  }

  // ----------------- Theme -----------------
  const THEME_KEY = "alwaysup_theme";
  function setTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(THEME_KEY, theme);

    const iconWrap = document.getElementById("themeIcon");
    const label = document.getElementById("themeLabel");
    if (theme === "dark") {
      label.textContent = "Light";
      iconWrap.innerHTML = `
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.8A8.5 8.5 0 1 1 11.2 3a6.5 6.5 0 0 0 9.8 9.8z"/>
        </svg>`;
    } else {
      label.textContent = "Dark";
      iconWrap.innerHTML = `
        <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="4" />
          <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" />
        </svg>`;
    }
    render();
  }
  function toggleTheme() {
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  }

  // ----------------- Events & Boot -----------------
  document.getElementById("tabStocks").addEventListener("click", () => setTab("stocks"));
  document.getElementById("tabCrypto").addEventListener("click", () => setTab("crypto"));
  document.getElementById("refresh").addEventListener("click", loadAll);
  document.getElementById("toggleTheme").addEventListener("click", toggleTheme);

  window.addEventListener("resize", () => {
    chartVibe.resize(); chartRaw.resize(); chartM2US.resize(); chartM2KR.resize(); chartFGS.resize(); chartFGC.resize();
  });

  setTheme(localStorage.getItem(THEME_KEY) || "dark");
  loadAll();
</script>
</body>
</html>
